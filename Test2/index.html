<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Auto M3U Player</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.6.0/controls.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.6.0/shaka-player.ui.min.js"></script>
<style>
html,body{margin:0;padding:0;height:100%;background:#000}
video{width:100%;height:100%;object-fit:contain;background:#000}
.loading{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;background:#000}
</style>
</head>
<body>
<div class="loading" id="loading">Loadingâ€¦</div>
<video id="video" autoplay muted playsinline></video>
<script>
const M3U_URL = "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u";

// fetch text, using proxy if GitHub blocks it
async function fetchText(url){
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error();
    return await r.text();
  }catch{
    const proxy = "https://api.allorigins.win/get?url=" + encodeURIComponent(url);
    const p = await fetch(proxy);
    const j = await p.json();
    return j.contents;
  }
}

// parse .m3u: take first non-comment line (the stream URL)
function parseM3U(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l && !l.startsWith("#"));
  const first = lines[0];
  // check for key/token style | separators
  const parts = first.split("|");
  return {
    url: parts[0],
    extras: parts.slice(1)
  };
}

async function init(){
  const loading = document.getElementById("loading");
  const video = document.getElementById("video");
  if(!shaka.Player.isBrowserSupported()){
    loading.textContent="Browser not supported";
    return;
  }
  shaka.polyfill.installAll();
  const player = new shaka.Player(video);
  new shaka.ui.Overlay(player, document.body, video);
  player.addEventListener("error",e=>{
    console.error("Shaka error:",e.detail);
    loading.textContent="Playback error";
  });

  try{
    const txt = await fetchText(M3U_URL);
    const {url} = parseM3U(txt);
    if(!url) throw new Error("No stream URL found in M3U");
    await player.load(url);
    loading.remove();

    // one-time tap/click for fullscreen
    const goFull = ()=>{
      if(!document.fullscreenElement){
        document.documentElement.requestFullscreen().catch(()=>{});
      }
      video.play();
      window.removeEventListener("click",goFull);
      window.removeEventListener("touchstart",goFull);
    };
    window.addEventListener("click",goFull,{once:true});
    window.addEventListener("touchstart",goFull,{once:true});
  }catch(err){
    console.error(err);
    loading.textContent="Failed: "+err.message;
  }
}

document.addEventListener("DOMContentLoaded",init);
</script>
</body>
</html>